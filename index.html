<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3537</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #2D2D2D;
            color: #F5F5F5;
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .main-container {
            max-width: 60vw;
            margin-left: 20px;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        .header-buttons {
            text-align: center;
            margin-bottom: 20px;
        }
        .header-buttons button {
            font-size: 2em;
            font-weight: 600;
            padding: 8px 16px;
            margin: 0 8px;
            background: #00CC66;
            color: #FFFFFF;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .header-buttons button:hover {
            background: #FFCC00;
        }
        .header-buttons button:active {
            background: #E6B800;
        }
        .header-buttons button.active {
            background: #FFCC00;
        }
        .input-section {
            margin-bottom: 20px;
            background: #3A3A3A;
            padding: 15px;
            border-radius: 6px;
            box-shadow: none;
        }
        label {
            font-weight: 600;
            color: #FFCC00;
            display: block;
            margin-bottom: 6px;
            font-size: 1em;
        }
        textarea, .editable-div {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
            background: #4A4A4A;
            color: #F5F5F5;
            border: none;
            border-radius: 4px;
            transition: background 0.3s ease;
        }
        textarea:hover, .editable-div:hover {
            background: #5A5A5A;
        }
        textarea:focus, .editable-div:focus {
            background: #5A5A5A;
            outline: none;
        }
        #title {
            min-height: 30px;
        }
        #content {
            min-height: 120px;
            white-space: pre-wrap;
        }
        .toolbar, .align-toolbar {
            margin: 10px 0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        button, select {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        button {
            background: #00CC66;
            color: #FFFFFF;
            font-weight: 600;
        }
        button:hover {
            background: #FFCC00;
        }
        button:active {
            background: #E6B800;
        }
        select {
            background: #4A4A4A;
            color: #F5F5F5;
            padding: 8px;
        }
        select:focus {
            outline: none;
        }
        select option {
            background: #4A4A4A;
            color: #FFCC00;
        }
        #output {
            white-space: pre-wrap;
            padding: 12px;
            border-radius: 4px;
            background: #3A3A3A;
            color: #E0E0E0;
            margin-top: 15px;
            font-family: 'JetBrains Mono', monospace;
            position: relative;
        }
        #bottom-preview {
            margin-top: 8px;
            padding: 10px;
            border-radius: 4px;
            background: #4A4A4A;
            min-height: 40px;
            text-align: center;
        }
        #content img.button-img {
            width: 80px;
            vertical-align: middle;
        }
        #content img.emoji-img {
            width: 25px;
            vertical-align: middle;
        }
        #content table {
            width: 100%;
            max-width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            table-layout: fixed;
        }
        #content td {
            border: 1px solid #FFFFFF;
            padding: 6px;
            text-align: center;
            word-break: break-all;
            overflow-wrap: break-word;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .divider {
            border-top: 1px solid #5A5A5A;
            margin: 20px 0;
        }
        .copy-success {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #FFCC00;
            color: #2D2D2D;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 1em;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        .copy-success.show {
            opacity: 1;
        }
        /* ÊâãÊú∫È¢ÑËßàÊ†∑Âºè */
        .phone-preview {
            position: fixed;
            right: 100px;
            top: 50%;
            transform: translateY(-50%);
            width: 375px;
            height: 667px;
            background: #121212;
            border-radius: 40px;
            border: 12px solid #1A1A1A;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9), inset 0 0 15px rgba(255, 255, 255, 0.1);
            overflow: hidden;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .phone-status-bar {
            height: 32px;
            background: #1A1A1A;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            color: #FFF;
            font-size: 11px;
        }
        .phone-status-bar .status-icons-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .phone-status-bar .status-icons-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .phone-status-bar .signal-icon::before {
            content: "üì∂";
        }
        .phone-status-bar .wifi-icon::before {
            content: "üì°";
        }
        .phone-status-bar .notification-icon::before {
            content: "üîî";
        }
        .phone-status-bar .bluetooth-icon::before {
            content: "üîµ";
        }
        .phone-status-bar .battery-icon::before {
            content: "üîã";
        }
        .phone-status-bar .phone-time {
            flex: 1;
            text-align: center;
        }
        .phone-content {
            flex: 1;
            background: #121212;
            padding: 8px;
            overflow-y: auto;
            font-family: Arial, sans-serif;
            margin-bottom: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .phone-content::-webkit-scrollbar {
            display: none;
        }
        .phone-header {
            font-size: 14px;
            font-weight: bold;
            color: #FFF;
            margin-bottom: 4px;
            text-align: center;
        }
        .phone-subheader {
            font-size: 12px;
            color: #FFF;
            margin-bottom: 4px;
        }
        .phone-timestamp {
            font-size: 10px;
            color: #999;
            margin-bottom: 8px;
        }
        .phone-body {
            font-size: 12px;
            color: #FFF;
            background: #121212;
        }
        .message-box {
            background: linear-gradient(145deg, #2A2A2A, #1E1E1E);
            border-radius: 20px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 4px 15px rgba(0, 0, 0, 0.6);
            color: #FFF;
            word-wrap: break-word;
            white-space: pre-wrap;
            border: 1px solid #4A4A4A;
            line-height: 1.4;
            opacity: 0.95;
        }
        .message-box img {
            max-width: 100%;
            height: auto;
        }
        .message-timestamp {
            font-size: 10px;
            color: #666;
            text-align: right;
            margin-top: 4px;
        }
        .phone-nav-bar {
            height: 44px;
            background: #121212;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #3A3A3A;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
        }
        .phone-nav-bar span {
            font-size: 16px;
            color: #FFF;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: transform 0.2s ease, background 0.3s ease;
        }
        .phone-nav-bar span:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        .phone-nav-bar span:active {
            transform: scale(0.9);
        }
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .main-container {
                max-width: 95vw;
                margin: 0 auto;
                padding: 10px;
            }
            .phone-preview {
                position: relative;
                width: 100%;
                max-width: 375px;
                height: 667px;
                margin: 20px auto;
                right: 0;
                top: 0;
                transform: none;
            }
            .header-buttons button {
                font-size: 1.5em;
                padding: 6px 12px;
            }
            .input-section {
                padding: 10px;
            }
            textarea, .editable-div {
                font-size: 12px;
            }
            button, select {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
        @media (max-width: 480px) {
            .main-container {
                max-width: 100vw;
                padding: 5px;
            }
            .phone-preview {
                height: 600px;
            }
            .header-buttons button {
                font-size: 1.2em;
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-buttons">
            <button id="btn-3537" class="active" onclick="switchMode('3537')">‚ú® 3537 ‚ú®</button>
            <button id="btn-6167" onclick="switchMode('6167')">‚ú® 6167 ‚ú®</button>
        </div>

        <div class="input-section">
            <label>üìù ‰∏ªÈ¢ò</label>
            <textarea id="title" placeholder="ËæìÂÖ•‰∏ªÈ¢ò"></textarea>
        </div>

        <div class="input-section">
            <label>üìã ÂÜÖÂÆπ</label>
            <div class="align-toolbar">
                <button onclick="alignText('left')">‚¨ÖÔ∏è Â∑¶ÂØπÈΩê</button>
                <button onclick="alignText('center')">‚ÜîÔ∏è Â±Ö‰∏≠ÂØπÈΩê</button>
                <button onclick="alignText('right')">‚û°Ô∏è Âè≥ÂØπÈΩê</button>
                <button onclick="addTable()">üìä Ê∑ªÂä†Ë°®Ê†º</button>
                <button onclick="formatText('bold')">ùêÅ Âä†Á≤ó</button>
                <button onclick="formatText('italic')">ùêº Êñú‰Ωì</button>
                <button onclick="formatText('underline')">ùêî ‰∏ãÂàíÁ∫ø</button>
            </div>
            <div id="content" class="editable-div" contenteditable="true" oninput="updateContent()"></div>
            <div class="toolbar">
                <button onclick="changeSelectedColor()">üé® È¢úËâ≤</button>
                <button onclick="addButton()">‚ûï Ê∑ªÂä†ÊåâÈíÆ</button>
                <select id="emojiSelect" onchange="addEmoji()">
                    <option value="">ÈÄâÊã©Ê∏∏Êàè Emoji</option>
                    <option value="JDB">JDB</option>
                    <option value="PG">PG</option>
                    <option value="CQ9">CQ9</option>
                    <option value="PP">PP</option>
                    <option value="JILI">JILI</option>
                    <option value="TADA">TADA</option>
                    <option value="WG">WG</option>
                </select>
            </div>
        </div>

        <div class="input-section">
            <label>üîó Â∫ïÈÉ®ÈÄâÈ°π</label>
            <div class="toolbar">
                <button onclick="addJumpButton()">üîó Ê∑ªÂä†Ë∑≥ËΩ¨ÊåâÈíÆ</button>
                <select id="bannerSelect" onchange="addBanner()">
                    <option value="">ÈÄâÊã©Ê®™ÂπÖ</option>
                    <option value="VIPÊ¥ªÂä®">VIPÊ¥ªÂä®</option>
                    <option value="‰ª£ÁêÜR$30">‰ª£ÁêÜR$30</option>
                    <option value="5%‰Ω£Èáë">5%‰Ω£Èáë</option>
                    <option value="Á•ûÁßòÂ•ñÈáëR$8888">Á•ûÁßòÂ•ñÈáëR$8888</option>
                    <option value="MAGNATA">MAGNATA</option>
                    <option value="ÊØèÊó•‰∫èÊçü">ÊØèÊó•‰∫èÊçü</option>
                    <option value="ÊØèÂë®‰∫èÊçü">ÊØèÂë®‰∫èÊçü</option>
                    <option value="N√≠vel">N√≠vel</option>
                    <option value="HAPPY">HAPPY</option>
                    <option value="5Âè∑20Âè∑">5Âè∑20Âè∑</option>
                    <option value="ÂÖçË¥π‰ª£Á†Å">ÂÖçË¥π‰ª£Á†Å</option>
                </select>
                <button onclick="addServiceButton()">üìû ÂÆ¢Êúç</button>
                <button onclick="cancelBottomContent()">‚ùå ÂèñÊ∂à</button>
            </div>
            <div>Â∫ïÈÉ®È¢ÑËßà:</div>
            <div id="bottom-preview"></div>
        </div>

        <div class="divider"></div>

        <div class="action-buttons">
            <button onclick="copyCode()">üìÑ Â§çÂà∂‰ª£Á†Å</button>
        </div>
        <pre id="output">ËØ∑Â°´ÂÜôÂÜÖÂÆπ‰ª•ÁîüÊàê‰ª£Á†Å</pre>
    </div>

    <div class="phone-preview">
        <div class="phone-status-bar">
            <div class="status-icons-left">
                <span class="signal-icon"></span>
                <span class="wifi-icon"></span>
                <span class="notification-icon"></span>
            </div>
            <span id="phone-time" class="phone-time"></span>
            <div class="status-icons-right">
                <span class="bluetooth-icon"></span>
                <span class="battery-icon"></span>
            </div>
        </div>
        <div class="phone-content">
            <div class="phone-header">ÈÄöÁü•</div>
            <div class="phone-subheader">Á´ôÂÜÖ‰ø°</div>
            <div class="phone-timestamp" id="phone-timestamp"></div>
            <div class="phone-body" id="phone-body">
                <div class="message-box" id="message-content"></div>
                <div class="message-timestamp">2025/03/23 03:49:37</div>
            </div>
        </div>
        <div class="phone-nav-bar">
            <span>‚óÑ</span>
            <span>‚ö™</span>
            <span>‚ñ¢</span>
        </div>
    </div>

    <script>
        const emojiMap = {
            "JDB": "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348342/4_zbwwzg.png",
            "PG": "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348343/2_n4m5ex.png",
            "CQ9": "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348343/5_cepuhg.png",
            "PP": "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348342/3_khmapl.png",
            "JILI": "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348344/6_tsocr4.png",
            "TADA": "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348345/7_ndnw7m.png",
            "WG": "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348346/8_yvcb8c.png"
        };

        const bannerMap = {
            "VIPÊ¥ªÂä®": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348921/1_suhssv.png", url: "https://3537s.com/#/sd-vip?game_type=11001&game_mode=1&anim_type=2" },
            "‰ª£ÁêÜR$30": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742372370/13_r4n0s7.png", url: "https://3537s.com/#/sdagency?game_type=11001&game_mode=1&anim_type=2" },
            "5%‰Ω£Èáë": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348921/2_mgh4qp.png", url: "https://3537s.com/#/home?game_type=11001&game_mode=1&anim_type=2" },
            "Á•ûÁßòÂ•ñÈáëR$8888": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742372370/11_mc4ivy.png", url: "https://3537s.com/#/sdmystery?game_type=11001&game_mode=1&anim_type=2" },
            "MAGNATA": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742372370/12_wfdyjn.png", url: "https://3537s.com/#/cashwheel?game_type=11001&game_mode=1&anim_type=2" },
            "ÊØèÊó•‰∫èÊçü": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348921/4_cy1qca.png", url: "https://3537s.com/#/sd-rescue?game_type=11001&game_mode=1&anim_type=2" },
            "ÊØèÂë®‰∫èÊçü": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348920/5_xakcw3.png", url: "https://3537s.com/#/sdweekb?game_type=11001&game_mode=1&anim_type=2" },
            "N√≠vel": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348921/7_dndgoh.png", url: "https://3537s.com/#/sd-level?game_type=11001&game_mode=1&anim_type=2" },
            "HAPPY": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742372370/8_gyaxzf.png", url: "https://3537s.com/#/sd-lottery?game_type=11001&game_mode=1&anim_type=2" },
            "5Âè∑20Âè∑": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742372370/9_su8hwk.png", url: "https://3537s.com/#/sdsuper?game_type=11001&game_mode=1&anim_type=2" },
            "ÂÖçË¥π‰ª£Á†Å": { img: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742348920/6_z8m3dy.png", url: "https://3537s.com/#/giftcode?game_type=11001&game_mode=1&anim_type=2" }
        };

        let currentMode = '3537';
        let bottomContent = "";
        let isJumpButton = false;
        let contentData = [];
        let generatedCode = "";
        let buttonConfig = {
            '3537': {
                buttonImg: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1741951273/button_-_3_ddqvtq.png",
                buttonUrl: "#/giftcode",
                jumpButtonImg: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1741934211/3537_BUTTON_4_mty74n.gif",
                jumpButtonUrl: "https://t.me/+9LQsBIYNZucxMmU1"
            },
            '6167': {
                buttonImg: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742470970/button_1_dihd5x.png",
                buttonUrl: "https://6167222.com/#/giftcode",
                jumpButtonImg: "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742470964/6167_button_1_zi62sd.gif",
                jumpButtonUrl: "https://t.me/+qBIuPiTwI0U1NzA1"
            }
        };

        function switchMode(mode) {
            if (currentMode !== mode) {
                currentMode = mode;
                localStorage.setItem('currentMode', mode);
                location.reload();
            }
        }

        window.onload = function() {
            const savedMode = localStorage.getItem('currentMode') || '3537';
            currentMode = savedMode;
            const btn3537 = document.getElementById('btn-3537');
            const btn6167 = document.getElementById('btn-6167');
            const bannerSelect = document.getElementById('bannerSelect');

            if (savedMode === '3537') {
                btn3537.classList.add('active');
                btn6167.classList.remove('active');
                bannerSelect.style.display = 'inline-block';
                document.title = '3537';
            } else {
                btn3537.classList.remove('active');
                btn6167.classList.add('active');
                bannerSelect.style.display = 'none';
                document.title = '6167';
            }
            generateCode();
        };

        document.getElementById("content").addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                const range = selection.getRangeAt(0);
                range.deleteContents();

                const br = document.createElement("br");
                range.insertNode(br);

                const newRange = document.createRange();
                newRange.setStartAfter(br);
                newRange.setEndAfter(br);
                selection.removeAllRanges();
                selection.addRange(newRange);

                updateContent();
            } else if (e.key === "Backspace") {
                e.preventDefault();
                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                const range = selection.getRangeAt(0);
                if (!range.collapsed) {
                    range.deleteContents();
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    const startContainer = range.startContainer;
                    const startOffset = range.startOffset;

                    if (startContainer.nodeType === Node.TEXT_NODE) {
                        if (startOffset > 0) {
                            range.setStart(startContainer, startOffset - 1);
                            range.setEnd(startContainer, startOffset);
                            range.deleteContents();
                            range.setStart(startContainer, startOffset - 1);
                            range.setEnd(startContainer, startOffset - 1);
                        } else {
                            const previousSibling = startContainer.previousSibling;
                            if (previousSibling) {
                                if (previousSibling.nodeName === "BR") {
                                    previousSibling.remove();
                                    range.setStart(startContainer, 0);
                                    range.setEnd(startContainer, 0);
                                } else if (previousSibling.nodeName === "IMG") {
                                    previousSibling.remove();
                                    range.setStart(startContainer, 0);
                                    range.setEnd(startContainer, 0);
                                }
                            } else {
                                const parent = startContainer.parentNode;
                                const previousParentSibling = parent.previousSibling;
                                if (previousParentSibling && (previousParentSibling.nodeName === "BR" || previousParentSibling.nodeName === "IMG")) {
                                    previousParentSibling.remove();
                                    range.setStart(startContainer, 0);
                                    range.setEnd(startContainer, 0);
                                }
                            }
                        }
                    } else if (startContainer.nodeType === Node.ELEMENT_NODE) {
                        if (startOffset > 0) {
                            const previousNode = startContainer.childNodes[startOffset - 1];
                            if (previousNode) {
                                if (previousNode.nodeName === "BR") {
                                    previousNode.remove();
                                    range.setStart(startContainer, startOffset - 1);
                                    range.setEnd(startContainer, startOffset - 1);
                                } else if (previousNode.nodeName === "IMG") {
                                    previousNode.remove();
                                    range.setStart(startContainer, startOffset - 1);
                                    range.setEnd(startContainer, startOffset - 1);
                                } else if (previousNode.nodeType === Node.TEXT_NODE && previousNode.textContent.length > 0) {
                                    const textLength = previousNode.textContent.length;
                                    previousNode.textContent = previousNode.textContent.substring(0, textLength - 1);
                                    range.setStart(previousNode, textLength - 1);
                                    range.setEnd(previousNode, textLength - 1);
                                }
                            }
                        } else {
                            const previousSibling = startContainer.previousSibling;
                            if (previousSibling && (previousSibling.nodeName === "BR" || previousSibling.nodeName === "IMG")) {
                                previousSibling.remove();
                                range.setStart(startContainer, 0);
                                range.setEnd(startContainer, 0);
                            } else {
                                const parent = startContainer.parentNode;
                                const previousParentSibling = parent.previousSibling;
                                if (previousParentSibling && (previousParentSibling.nodeName === "BR" || previousParentSibling.nodeName === "IMG")) {
                                    previousParentSibling.remove();
                                    range.setStart(startContainer, 0);
                                    range.setEnd(startContainer, 0);
                                }
                            }
                        }
                    }

                    if (startContainer.nodeType === Node.ELEMENT_NODE && startContainer.childNodes.length === 0) {
                        const textNode = document.createTextNode("");
                        startContainer.appendChild(textNode);
                        range.setStart(textNode, 0);
                        range.setEnd(textNode, 0);
                    } else if (startContainer.nodeType === Node.TEXT_NODE && startContainer.textContent === "" && !startContainer.previousSibling && !startContainer.nextSibling) {
                        range.setStart(startContainer, 0);
                        range.setEnd(startContainer, 0);
                    }
                }
                selection.removeAllRanges();
                selection.addRange(range);
                updateContent();
            }
        });

        document.getElementById("content").addEventListener("paste", function(e) {
            e.preventDefault();
            const clipboardData = e.clipboardData || window.clipboardData;
            const htmlData = clipboardData.getData("text/html");
            const textData = clipboardData.getData("text/plain");

            if (htmlData && (htmlData.includes("button-img") || htmlData.includes("emoji-img"))) {
                const div = document.createElement("div");
                div.innerHTML = htmlData;
                const fragment = document.createDocumentFragment();
                let lastNodeWasBr = false;

                Array.from(div.childNodes).forEach(node => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent;
                        if (text.trim() !== '' || lastNodeWasBr) {
                            fragment.appendChild(node.cloneNode(true));
                        }
                        lastNodeWasBr = false;
                    } else if (node.nodeName === "IMG" && (node.className === "button-img" || node.className === "emoji-img")) {
                        fragment.appendChild(node.cloneNode(true));
                        lastNodeWasBr = false;
                    } else if (node.nodeName === "BR") {
                        fragment.appendChild(document.createElement("br"));
                        lastNodeWasBr = true;
                    }
                });

                const selection = window.getSelection();
                if (selection.rangeCount) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(fragment);
                    range.setStartAfter(fragment.lastChild || fragment);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    document.getElementById("content").appendChild(fragment);
                }
            } else {
                const lines = textData.split(/\r?\n/);
                let html = '';
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line) {
                        html += line;
                    }
                    if (i < lines.length - 1) {
                        html += '<br>';
                    }
                }
                document.execCommand("insertHTML", false, html);
            }
            updateContent();
        });

        function alignText(alignment) {
            const content = document.getElementById("content");
            const selection = window.getSelection();
            if (!selection.rangeCount || !selection.getRangeAt(0).commonAncestorContainer.parentNode.closest("#content")) return;

            const range = selection.getRangeAt(0);
            if (range.collapsed) return;

            const td = range.commonAncestorContainer.parentNode.closest("td");
            if (td) {
                const fragment = range.extractContents();
                const alignDiv = document.createElement("div");
                alignDiv.style.textAlign = alignment;
                alignDiv.appendChild(fragment);
                // Á°Æ‰øù div ÂÜÖÁöÑ span ÂÖÉÁ¥†ËÉΩÂ§üÂìçÂ∫î text-align
                const spans = alignDiv.getElementsByTagName("span");
                for (let span of spans) {
                    span.style.display = "inline-block";
                }
                range.insertNode(alignDiv);

                const newRange = document.createRange();
                const lastChild = alignDiv.lastChild;
                if (lastChild.nodeType === Node.TEXT_NODE) {
                    newRange.setStart(lastChild, lastChild.length);
                    newRange.setEnd(lastChild, lastChild.length);
                } else if (lastChild.nodeType === Node.ELEMENT_NODE) {
                    newRange.setStartAfter(lastChild);
                    newRange.setEndAfter(lastChild);
                } else {
                    newRange.setStart(alignDiv, alignDiv.childNodes.length);
                    newRange.setEnd(alignDiv, alignDiv.childNodes.length);
                }
                selection.removeAllRanges();
                selection.addRange(newRange);
            } else {
                const fragment = range.extractContents();
                const alignDiv = document.createElement("div");
                alignDiv.style.textAlign = alignment;
                alignDiv.appendChild(fragment);
                // Á°Æ‰øù div ÂÜÖÁöÑ span ÂÖÉÁ¥†ËÉΩÂ§üÂìçÂ∫î text-align
                const spans = alignDiv.getElementsByTagName("span");
                for (let span of spans) {
                    span.style.display = "inline-block";
                }
                range.insertNode(alignDiv);

                let nextSibling = alignDiv.nextSibling;
                while (nextSibling && (nextSibling.nodeName === "BR" || (nextSibling.nodeType === Node.TEXT_NODE && nextSibling.textContent.trim() === ""))) {
                    const toRemove = nextSibling;
                    nextSibling = nextSibling.nextSibling;
                    toRemove.remove();
                }

                const newRange = document.createRange();
                const lastChild = alignDiv.lastChild;
                if (lastChild.nodeType === Node.TEXT_NODE) {
                    newRange.setStart(lastChild, lastChild.length);
                    newRange.setEnd(lastChild, lastChild.length);
                } else if (lastChild.nodeType === Node.ELEMENT_NODE) {
                    newRange.setStartAfter(lastChild);
                    newRange.setEndAfter(lastChild);
                } else {
                    newRange.setStart(alignDiv, alignDiv.childNodes.length);
                    newRange.setEnd(alignDiv, alignDiv.childNodes.length);
                }
                selection.removeAllRanges();
                selection.addRange(newRange);
            }

            updateContent();
        }

        function formatText(format) {
            const content = document.getElementById("content");
            const selection = window.getSelection();
            if (!selection.rangeCount || !selection.getRangeAt(0).commonAncestorContainer.parentNode.closest("#content")) return;

            const range = selection.getRangeAt(0);
            const selectedText = range.toString();
            if (!selectedText) return;

            // Ê£ÄÊü•ÈÄâ‰∏≠ÁöÑÂÜÖÂÆπÊòØÂê¶Â∑≤ÁªèÂåÖÂê´Âú®‰∏Ä‰∏™ span Ê†áÁ≠æ‰∏≠
            let parentSpan = range.commonAncestorContainer.parentNode;
            while (parentSpan && parentSpan.nodeName !== "SPAN" && parentSpan !== content) {
                parentSpan = parentSpan.parentNode;
            }

            let span;
            if (parentSpan && parentSpan.nodeName === "SPAN") {
                // Â¶ÇÊûúÂ∑≤ÁªèÊúâ‰∏Ä‰∏™ span Ê†áÁ≠æÔºåÂ§çÁî®ÂÆÉÂπ∂Ê∑ªÂä†Êñ∞Ê†∑Âºè
                span = parentSpan;
                if (format === "bold") {
                    span.style.fontWeight = "bold";
                } else if (format === "italic") {
                    span.style.fontStyle = "italic";
                } else if (format === "underline") {
                    span.style.textDecoration = "underline";
                }
            } else {
                // Âê¶ÂàôÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ span Ê†áÁ≠æ
                span = document.createElement("span");
                if (format === "bold") {
                    span.style.fontWeight = "bold";
                } else if (format === "italic") {
                    span.style.fontStyle = "italic";
                } else if (format === "underline") {
                    span.style.textDecoration = "underline";
                }
                span.textContent = selectedText;
                range.deleteContents();
                range.insertNode(span);
            }

            const newRange = document.createRange();
            newRange.setStartAfter(span);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);

            updateContent();
        }

        function addTable() {
            const rows = parseInt(prompt("ËØ∑ËæìÂÖ•Ë°®Ê†ºË°åÊï∞Ôºö", "2"));
            const cols = parseInt(prompt("ËØ∑ËæìÂÖ•Ë°®Ê†ºÂàóÊï∞Ôºö", "2"));

            if (!rows || !cols || rows <= 0 || cols <= 0) {
                alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑË°åÊï∞ÂíåÂàóÊï∞ÔºÅ");
                return;
            }

            const content = document.getElementById("content");
            const table = document.createElement("table");
            table.dataset.code = `<table style="width: 100%; max-width: 100%; border-collapse: collapse; margin: 10px 0; table-layout: fixed;">\n`;

            for (let i = 0; i < rows; i++) {
                const tr = document.createElement("tr");
                table.dataset.code += "<tr>";
                for (let j = 0; j < cols; j++) {
                    const td = document.createElement("td");
                    td.textContent = " ";
                    tr.appendChild(td);
                    table.dataset.code += `<td style="border: 1px solid #FFFFFF; padding: 8px; text-align: center; word-break: break-all; overflow-wrap: break-word;"> </td>`;
                }
                table.dataset.code += "</tr>\n";
                table.appendChild(tr);
            }
            table.dataset.code += "</table>";

            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.getRangeAt(0).commonAncestorContainer.parentNode.closest("#content")) {
                const range = selection.getRangeAt(0);
                range.insertNode(table);
                range.setStartAfter(table);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                content.appendChild(table);
            }
            updateContent();
        }

        function changeSelectedColor() {
            const content = document.getElementById("content");
            const selection = window.getSelection();
            if (!selection.rangeCount || !selection.getRangeAt(0).commonAncestorContainer.parentNode.closest("#content")) return;

            const range = selection.getRangeAt(0);
            const selectedText = range.toString();
            if (!selectedText) return;

            // Ê£ÄÊü•ÈÄâ‰∏≠ÁöÑÂÜÖÂÆπÊòØÂê¶Â∑≤ÁªèÂåÖÂê´Âú®‰∏Ä‰∏™ span Ê†áÁ≠æ‰∏≠
            let parentSpan = range.commonAncestorContainer.parentNode;
            while (parentSpan && parentSpan.nodeName !== "SPAN" && parentSpan !== content) {
                parentSpan = parentSpan.parentNode;
            }

            let coloredSpan;
            if (parentSpan && parentSpan.nodeName === "SPAN") {
                // Â¶ÇÊûúÂ∑≤ÁªèÊúâ‰∏Ä‰∏™ span Ê†áÁ≠æÔºåÂ§çÁî®ÂÆÉÂπ∂Ê∑ªÂä†È¢úËâ≤Ê†∑Âºè
                coloredSpan = parentSpan;
                coloredSpan.style.color = "#CAFF70";
            } else {
                // Âê¶ÂàôÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ span Ê†áÁ≠æ
                coloredSpan = document.createElement("span");
                coloredSpan.style.color = "#CAFF70";
                coloredSpan.textContent = selectedText;
                range.deleteContents();
                range.insertNode(coloredSpan);
            }

            const defaultSpan = document.createElement("span");
            defaultSpan.style.color = "#000000";
            defaultSpan.textContent = "";
            range.insertNode(defaultSpan);

            selection.removeAllRanges();
            const newRange = document.createRange();
            newRange.setStart(defaultSpan, 0);
            newRange.collapse(true);
            selection.addRange(newRange);

            updateContent();
        }

        function addButton() {
            const content = document.getElementById("content");
            const img = document.createElement("img");
            img.src = buttonConfig[currentMode].buttonImg;
            img.alt = "Bot√£o";
            img.className = "button-img";
            img.dataset.code = `<a href="${buttonConfig[currentMode].buttonUrl}" target="_self"><img src="${buttonConfig[currentMode].buttonImg}" alt="Bot√£o" style="vertical-align: middle; width: 25%; filter: drop-shadow(0 0 10px #CAFF70);"/></a>`;

            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.getRangeAt(0).commonAncestorContainer.parentNode.closest("#content")) {
                const range = selection.getRangeAt(0);
                range.insertNode(img);
                range.setStartAfter(img);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                content.appendChild(img);
            }
            updateContent();
        }

        function addEmoji() {
            const select = document.getElementById("emojiSelect");
            const value = select.value;
            if (value && emojiMap[value]) {
                const content = document.getElementById("content");
                const img = document.createElement("img");
                img.src = emojiMap[value];
                img.alt = "Logo";
                img.className = "emoji-img";
                img.dataset.code = `<img src="${emojiMap[value]}" alt="Logo" style="width: 12%; height: auto; vertical-align: middle; margin-top: 0px;"/>`;

                const selection = window.getSelection();
                if (selection.rangeCount > 0 && selection.getRangeAt(0).commonAncestorContainer.parentNode.closest("#content")) {
                    const range = selection.getRangeAt(0);
                    range.insertNode(img);
                    range.setStartAfter(img);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    content.appendChild(img);
                }
                updateContent();
            }
            select.value = "";
        }

        function addJumpButton() {
            bottomContent = `<a href="${buttonConfig[currentMode].jumpButtonUrl}" target="_blank"><img src="${buttonConfig[currentMode].jumpButtonImg}" style="width: 80%; height: auto; margin-top: 10px; display:block; margin-left:auto; margin-right:auto;"/></a></div>`;
            isJumpButton = true;
            const preview = document.getElementById("bottom-preview");
            preview.innerHTML = `<img src="${buttonConfig[currentMode].jumpButtonImg}" style="width: 200px; height: auto;"/>`;
            generateCode();
        }

        function addBanner() {
            const select = document.getElementById("bannerSelect");
            const value = select.value;
            if (value && bannerMap[value]) {
                bottomContent = `<a href="${bannerMap[value].url}"><img src="${bannerMap[value].img}" alt="Atividade" style="display:block; margin: 20px auto; width: 100%; max-width: 1200px;"/></a></div>`;
                isJumpButton = false;
                const preview = document.getElementById("bottom-preview");
                preview.innerHTML = `<img src="${bannerMap[value].img}" style="width: 300px; height: auto;"/>`;
                generateCode();
            }
            select.value = "";
        }

        function addServiceButton() {
            const serviceImg = "https://res.cloudinary.com/daw3jjnsf/image/upload/v1742723669/GIF3_1_eow7ll.gif";
            const serviceUrl = "https://3537.live?groupid=57dbaa4b3cd5ec107bd350ed5f63918c&language=pt";
            bottomContent = `<a href="${serviceUrl}"><img src="${serviceImg}" alt="Atividade" style="display:block; margin: 20px auto; width: 100%; max-width: 1200px;"/></a></div>`;
            isJumpButton = false;
            const preview = document.getElementById("bottom-preview");
            preview.innerHTML = `<img src="${serviceImg}" style="width: 300px; height: auto;"/>`;
            generateCode();
        }

        function cancelBottomContent() {
            bottomContent = "";
            isJumpButton = false;
            const preview = document.getElementById("bottom-preview");
            preview.innerHTML = "";
            generateCode();
        }

        function updateContent() {
            const content = document.getElementById("content");
            contentData = [];

            function mergeStyles(node) {
                const styles = {};
                let currentNode = node;
                // ÈÄíÂΩíÂêàÂπ∂ÊâÄÊúâÂµåÂ•ó span ÁöÑÊ†∑Âºè
                while (currentNode && currentNode.nodeName === "SPAN") {
                    if (currentNode.style.color) styles.color = currentNode.style.color;
                    if (currentNode.style.fontWeight === "bold") styles.fontWeight = "bold";
                    if (currentNode.style.fontStyle === "italic") styles.fontStyle = "italic";
                    if (currentNode.style.textDecoration === "underline") styles.textDecoration = "underline";
                    if (currentNode.style.display === "inline-block") styles.display = "inline-block";
                    currentNode = currentNode.parentNode;
                }
                return styles;
            }

            function processNode(node, isNestedDiv = false) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    if (text) {
                        const formattedText = text.replace(/\u00A0/g, " ");
                        contentData.push({ type: "text", value: formattedText });
                    }
                } else if (node.nodeName === "SPAN") {
                    const styles = mergeStyles(node); // ÂêàÂπ∂ÂµåÂ•óÁöÑÊ†∑Âºè
                    const childrenData = [];
                    const tempContentData = contentData;
                    contentData = [];
                    node.childNodes.forEach(child => processNode(child));
                    childrenData.push(...contentData);
                    contentData = tempContentData;
                    if (childrenData.length > 0) {
                        contentData.push({ type: "span", children: childrenData, styles: styles });
                    }
                } else if (node.nodeName === "DIV" && node !== content) {
                    contentData.push({ type: "div_start", align: node.style.textAlign || "left" });
                    node.childNodes.forEach(child => processNode(child, true));
                    contentData.push({ type: "div_end" });
                } else if (node.nodeName === "TABLE") {
                    const tableCode = generateTableCode(node);
                    contentData.push({ type: "table", code: tableCode });
                } else if (node.nodeName === "IMG") {
                    contentData.push({ type: "img", code: node.dataset.code });
                } else if (node.nodeName === "BR") {
                    contentData.push({ type: "newline" });
                } else {
                    node.childNodes.forEach(child => processNode(child, isNestedDiv));
                }
            }

            function processTdContent(node) {
                let tdContent = "";
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    tdContent += text.replace(/\u00A0/g, " ");
                } else if (node.nodeName === "DIV") {
                    const divContent = Array.from(node.childNodes).map(child => processTdContent(child)).join('');
                    tdContent += `<div style="text-align:${node.style.textAlign || 'center'};">${divContent}</div>`;
                } else if (node.nodeName === "SPAN") {
                    const styles = [];
                    if (node.style.color) styles.push(`color:${node.style.color}`);
                    if (node.style.fontWeight === "bold") styles.push(`font-weight:bold`);
                    if (node.style.fontStyle === "italic") styles.push(`font-style:italic`);
                    if (node.style.textDecoration === "underline") styles.push(`text-decoration:underline`);
                    if (node.style.display === "inline-block") styles.push(`display:inline-block`);
                    const spanContent = Array.from(node.childNodes).map(child => processTdContent(child)).join('');
                    tdContent += `<span style="${styles.join(';')}">${spanContent}</span>`;
                } else if (node.nodeName === "IMG") {
                    tdContent += node.dataset.code;
                } else if (node.nodeName === "BR") {
                    tdContent += "\n";
                } else {
                    node.childNodes.forEach(child => {
                        tdContent += processTdContent(child);
                    });
                }
                return tdContent;
            }

            function generateTableCode(table) {
                let code = `<table style="width: 100%; max-width: 100%; border-collapse: collapse; margin: 10px 0; table-layout: fixed;">\n`;
                const rows = table.getElementsByTagName("tr");
                for (let i = 0; i < rows.length; i++) {
                    code += "<tr>";
                    const cells = rows[i].getElementsByTagName("td");
                    for (let j = 0; j < cells.length; j++) {
                        const td = cells[j];
                        let tdContent = "";
                        td.childNodes.forEach(child => {
                            tdContent += processTdContent(child);
                        });
                        code += `<td style="border: 1px solid #FFFFFF; padding: 8px; text-align: center; word-break: break-all; overflow-wrap: break-word;">${tdContent}</td>`;
                    }
                    code += "</tr>\n";
                }
                code += "</table>";
                return code;
            }

            content.childNodes.forEach(node => processNode(node));
            generateCode();
        }

        function generateCode() {
            const title = document.getElementById("title").value;
            let output = `<div style="font-family:Arial,sans-serif;">`;

            // ‰∏ªÈ¢ò
            if (title) {
                output += `<span style="color:#CAFF70;">${title}</span><br>\n`;
            }

            // ÂÜÖÂÆπ
            output += `<span style="color:#FFFFFF;">`;

            // ÈÄíÂΩíÁîüÊàê HTML ÁªìÊûÑ
            function generateNestedCode(data, startIndex) {
                let html = "";
                let i = startIndex;
                while (i < data.length) {
                    const item = data[i];
                    if (item.type === "text") {
                        html += item.value;
                    } else if (item.type === "span") {
                        const styles = [];
                        if (item.styles.color) styles.push(`color:${item.styles.color}`);
                        if (item.styles.fontWeight) styles.push(`font-weight:${item.styles.fontWeight}`);
                        if (item.styles.fontStyle) styles.push(`font-style:${item.styles.fontStyle}`);
                        if (item.styles.textDecoration) styles.push(`text-decoration:${item.styles.textDecoration}`);
                        if (item.styles.display) styles.push(`display:${item.styles.display}`);
                        html += `<span style="${styles.join(';')}">`;
                        item.children.forEach(child => {
                            if (child.type === "text") {
                                html += child.value;
                            } else if (child.type === "newline") {
                                html += "\n";
                            }
                        });
                        html += `</span>`;
                    } else if (item.type === "div_start") {
                        html += `<div style="text-align:${item.align};">`;
                        // ÈÄíÂΩíÂ§ÑÁêÜ div ÂÜÖÈÉ®ÁöÑÂÜÖÂÆπ
                        const nestedResult = generateNestedCode(data, i + 1);
                        html += nestedResult.html;
                        i = nestedResult.endIndex - 1; // Ë∑≥Âà∞ div_end ÁöÑ‰ΩçÁΩÆ
                    } else if (item.type === "div_end") {
                        html += `</div>`;
                        return { html, endIndex: i + 1 };
                    } else if (item.type === "table") {
                        html += item.code;
                    } else if (item.type === "img") {
                        html += item.code;
                    } else if (item.type === "newline") {
                        html += "\n";
                    }
                    i++;
                }
                return { html, endIndex: i };
            }

            const result = generateNestedCode(contentData, 0);
            output += result.html;
            output += "</span>";

            // Â∫ïÈÉ®ÂÜÖÂÆπÔºàË∑≥ËΩ¨ÊåâÈíÆÊàñÊ®™ÂπÖÔºâ
            if (bottomContent) {
                if (isJumpButton) {
                    output += "\n\n";
                }
                output += bottomContent;
            } else {
                output += "\n</div>";
            }

            generatedCode = output || "ËØ∑Â°´ÂÜôÂÜÖÂÆπ‰ª•ÁîüÊàê‰ª£Á†Å";
            document.getElementById("output").textContent = generatedCode;
            updatePhonePreview();
        }

        function copyCode() {
            if (!generatedCode || generatedCode === "ËØ∑Â°´ÂÜôÂÜÖÂÆπ‰ª•ÁîüÊàê‰ª£Á†Å") {
                alert("ËØ∑Â°´ÂÜôÂÜÖÂÆπ‰ª•ÁîüÊàê‰ª£Á†ÅÔºÅ");
                return;
            }
            navigator.clipboard.writeText(generatedCode);

            let successMessage = document.querySelector('.copy-success');
            if (!successMessage) {
                successMessage = document.createElement('div');
                successMessage.className = 'copy-success';
                successMessage.textContent = 'Â§çÂà∂ÊàêÂäüÔºÅ';
                document.getElementById("output").appendChild(successMessage);
            }

            successMessage.classList.add('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 2000);
        }

        function updatePhoneTime() {
            const options = {
                timeZone: 'Europe/London',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            const time = new Intl.DateTimeFormat('zh-CN', options).format(new Date());
            document.getElementById("phone-time").textContent = time;

            const timestampOptions = {
                timeZone: 'Europe/London',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            const timestamp = new Intl.DateTimeFormat('zh-CN', timestampOptions).format(new Date());
            document.getElementById("phone-timestamp").textContent = `ÂèëÂ∏ÉÊó∂Èó¥: ${timestamp}`;
        }

        function updatePhonePreview() {
            const messageContent = document.getElementById("message-content");
            if (generatedCode === "ËØ∑Â°´ÂÜôÂÜÖÂÆπ‰ª•ÁîüÊàê‰ª£Á†Å") {
                messageContent.textContent = "ÊöÇÊó†ÂÜÖÂÆπ";
            } else {
                messageContent.innerHTML = generatedCode;
            }
            updatePhoneTime();
        }

        document.getElementById("title").addEventListener("input", updateContent);
        generateCode();
        setInterval(updatePhoneTime, 1000);
    </script>
</body>
</html>
